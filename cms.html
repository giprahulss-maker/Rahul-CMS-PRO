<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Rahul Publishing Studio v3.0</title>

<link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/grapesjs"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.2/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<link rel="manifest" href="manifest.json">

<style>
:root {
  --primary:#2563eb;
  --heading:#111827;
  --text:#374151;
  --bg:#ffffff;
}

body { margin:0; font-family:Arial; background:#f3f4f6; }
body.dark { background:#111827; color:white; }

.topbar {
  background:#111827;
  padding:15px 30px;
  color:white;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.main { display:flex; }

.sidebar {
  width:280px;
  background:white;
  padding:20px;
  border-right:1px solid #e5e7eb;
  height:90vh;
  overflow:auto;
}

.editor-area {
  flex:1;
  background:white;
  margin:20px;
  border-radius:12px;
  overflow:hidden;
}

button,input { margin-bottom:6px; width:100%; }
</style>
</head>

<body>

<div class="topbar">
  <div>Rahul Publishing Studio</div>
  <div>
    <input type="color" id="themeColor">
    <button onclick="toggleDark()">Dark</button>
    <button onclick="generateSummary()">Summary</button>
    <button onclick="autoNumberFigures()">Number Figures</button>
    <button onclick="exportPDF()">PDF</button>
    <button onclick="exportDOCX()">DOCX</button>
    <button onclick="exportAll()">Website</button>
    <button onclick="backupProject()">Backup</button>
    <input type="file" onchange="restoreProject(event)">
  </div>
</div>

<div class="main">
  <div class="sidebar">
    <h3>Pages</h3>
    <div id="pageList"></div>
    <button onclick="addPage()">+ Add Page</button>

    <hr>

    <input type="file" id="imageUpload" accept="image/*">
    <button onclick="insertImage()">Insert Image</button>

    <hr>

    <input type="file" id="pdfUpload" accept="application/pdf">
    <button onclick="extractPDF()">Smart PDF Extract</button>

    <hr>

    <button onclick="addCitation()">Add Citation</button>
    <button onclick="insertCitation()">Insert Citation</button>
    <button onclick="generateReferences()">Generate References</button>
  </div>

  <div class="editor-area">
    <div id="gjs"></div>
  </div>
</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

/* ================= STATE ================= */

let project = JSON.parse(localStorage.getItem("rahulStudio")) || { pages:{} };
let citations = JSON.parse(localStorage.getItem("rahulCitations")) || [];

let currentPage = Object.keys(project.pages)[0] || "home";
if(!project.pages[currentPage]) project.pages[currentPage] = null;

/* ================= EDITOR ================= */

const editor = grapesjs.init({
  container:'#gjs',
  height:'100%',
  storageManager:false
});

editor.on('update', ()=> saveCurrent());

/* ================= BLOCKS ================= */

editor.BlockManager.add('unit-template',{
  label:'Unit Template',
  content:`
  <section style="padding:40px;">
    <h1>Unit Title</h1>
    <h3>Objectives</h3>
    <ul><li>Objective 1</li></ul>
    <h3>Content</h3>
    <p>Write structured notes here...</p>
  </section>`
});

/* ================= PAGE SYSTEM ================= */

function renderPages(){
  const list=document.getElementById("pageList");
  list.innerHTML="";
  Object.keys(project.pages).forEach(p=>{
    const btn=document.createElement("button");
    btn.innerText=p;
    btn.onclick=()=>switchPage(p);
    list.appendChild(btn);
  });

  new Sortable(list,{
    animation:150,
    onEnd:function(){
      const order=[];
      document.querySelectorAll("#pageList button")
        .forEach(btn=>order.push(btn.innerText));
      const reordered={};
      order.forEach(p=>reordered[p]=project.pages[p]);
      project.pages=reordered;
      saveCurrent();
    }
  });
}

function addPage(){
  const name=prompt("Page Name:");
  if(!name) return;
  saveCurrent();
  project.pages[name]=null;
  currentPage=name;
  editor.setComponents(`<h1>${name}</h1>`);
  saveCurrent();
  renderPages();
}

function switchPage(name){
  saveCurrent();
  currentPage=name;
  if(project.pages[name]){
    editor.loadProjectData(project.pages[name]);
  } else {
    editor.setComponents(`<h1>${name}</h1>`);
  }
}

function saveCurrent(){
  project.pages[currentPage]=editor.getProjectData();
  localStorage.setItem("rahulStudio", JSON.stringify(project));
}

/* ================= IMAGE ================= */

function insertImage(){
  const file=document.getElementById("imageUpload").files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    editor.addComponents(`
      <figure style="text-align:center;padding:20px;">
        <img src="${e.target.result}" style="max-width:100%;">
        <figcaption>Caption</figcaption>
      </figure>
    `);
  };
  reader.readAsDataURL(file);
}

/* ================= PDF SMART EXTRACT ================= */

async function extractPDF(){
  const file=document.getElementById("pdfUpload").files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=async function(){
    const pdf=await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
    let structured="";
    for(let i=1;i<=pdf.numPages;i++){
      const page=await pdf.getPage(i);
      const content=await page.getTextContent();
      const lines=content.items.map(it=>it.str);
      lines.forEach(line=>{
        if(line.match(/^[A-Z\s]{5,}$/)) structured+=`<h2>${line}</h2>`;
        else if(line.match(/^\d+(\.\d+)*\s/)) structured+=`<h3>${line}</h3>`;
        else structured+=line+" ";
      });
      structured+="<br><br>";
    }
    editor.addComponents(`<section><h1>Extracted</h1>${structured}</section>`);
  };
  reader.readAsArrayBuffer(file);
}

/* ================= SUMMARY ================= */

function generateSummary(){
  const html=editor.getHtml();
  const temp=document.createElement("div");
  temp.innerHTML=html;
  let summary="<h2>Summary</h2><ul>";
  temp.querySelectorAll("h1,h2,h3").forEach(h=>{
    let next=h.nextElementSibling;
    if(next){
      const text=next.innerText.split(".").slice(0,2).join(".");
      summary+=`<li><strong>${h.innerText}:</strong> ${text}.</li>`;
    }
  });
  summary+="</ul>";
  editor.addComponents(`<section style="padding:40px;">${summary}</section>`);
}

/* ================= FIGURE NUMBERING ================= */

function autoNumberFigures(){
  const figs=editor.getWrapper().find("figure");
  figs.forEach((fig,i)=>{
    const cap=fig.find("figcaption")[0];
    if(cap){
      cap.components(`Figure ${i+1}: ${cap.components().toString()}`);
    }
  });
}

/* ================= CITATIONS ================= */

function addCitation(){
  const ref=prompt("Enter reference:");
  if(ref){
    citations.push(ref);
    localStorage.setItem("rahulCitations",JSON.stringify(citations));
  }
}

function insertCitation(){
  const index=prompt("Citation number:");
  if(index) editor.addComponents(`<sup>[${index}]</sup>`);
}

function generateReferences(){
  let html="<h2>References</h2><ol>";
  citations.forEach(r=>html+=`<li>${r}</li>`);
  html+="</ol>";
  editor.addComponents(`<section>${html}</section>`);
}

/* ================= EXPORT WEBSITE ================= */

async function exportAll(){
  saveCurrent();
  const zip=new JSZip();
  let sitemap='<?xml version="1.0"?><urlset>';

  Object.keys(project.pages).forEach(p=>{
    editor.loadProjectData(project.pages[p]);
    const html=editor.getHtml();
    const css=editor.getCss();
    zip.file(p+".html",`<html><head><style>${css}</style></head><body>${html}</body></html>`);
    sitemap+=`<url><loc>${p}.html</loc></url>`;
  });

  sitemap+='</urlset>';
  zip.file("sitemap.xml",sitemap);

  const blob=await zip.generateAsync({type:"blob"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="rahul-site.zip";
  a.click();
}

/* ================= EXPORT PDF ================= */

function exportPDF(){
  const element=document.createElement("div");
  element.innerHTML=editor.getHtml();
  html2pdf().from(element).save(currentPage+".pdf");
}

/* ================= EXPORT DOCX ================= */

async function exportDOCX(){
  const text=editor.getHtml().replace(/<[^>]+>/g,"");
  const doc=new docx.Document({
    sections:[{children:[new docx.Paragraph(text)]}]
  });
  const blob=await docx.Packer.toBlob(doc);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=currentPage+".docx";
  a.click();
}

/* ================= BACKUP ================= */

function backupProject(){
  const blob=new Blob([JSON.stringify(project)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="backup.json";
  a.click();
}

function restoreProject(e){
  const reader=new FileReader();
  reader.onload=function(){
    project=JSON.parse(this.result);
    localStorage.setItem("rahulStudio",JSON.stringify(project));
    location.reload();
  };
  reader.readAsText(e.target.files[0]);
}

/* ================= UI ================= */

function toggleDark(){ document.body.classList.toggle("dark"); }

document.getElementById("themeColor")
.addEventListener("input",e=>{
  document.documentElement.style.setProperty('--primary', e.target.value);
});

/* INIT */
renderPages();
switchPage(currentPage);

</script>
</body>
</html>
