<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Rahul Publishing Studio v2.0</title>

<!-- GrapesJS -->
<link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/grapesjs"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- JSZip -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- DOCX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.2/docx.min.js"></script>

<!-- HTML2PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Sortable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
body { margin:0; font-family:Arial; background:#fff; }
body.dark { background:#111827; color:white; }

.topbar {
  background:#111827;
  color:white;
  padding:10px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.main {
  display:flex;
}

.sidebar {
  width:260px;
  background:#1f2937;
  color:white;
  height:90vh;
  overflow:auto;
  padding:10px;
}

.sidebar button, .sidebar input {
  width:100%;
  margin-bottom:6px;
}

.sidebar button {
  padding:8px;
  border:none;
  background:none;
  color:white;
  cursor:pointer;
}

.sidebar button:hover {
  background:#374151;
}

.editor-area {
  flex:1;
  height:90vh;
}
</style>
</head>

<body>

<div class="topbar">
  <div>Rahul Publishing Studio</div>
  <div>
    <input type="color" id="themeColor">
    <button onclick="toggleDark()">Dark</button>
    <button onclick="exportPDF()">PDF</button>
    <button onclick="exportDOCX()">DOCX</button>
    <button onclick="exportAll()">Export Website</button>
    <button onclick="backupProject()">Backup</button>
    <input type="file" onchange="restoreProject(event)">
  </div>
</div>

<div class="main">
  <div class="sidebar">
    <h3>Pages</h3>
    <div id="pageList"></div>
    <button onclick="addPage()">+ Add Page</button>

    <hr>

    <input type="file" id="imageUpload" accept="image/*">
    <button onclick="insertImage()">Insert Image</button>

    <hr>

    <input type="file" id="pdfUpload" accept="application/pdf">
    <button onclick="extractPDF()">Smart PDF Extract</button>
  </div>

  <div class="editor-area">
    <div id="gjs"></div>
  </div>
</div>

<script>

/* ======================
   PROJECT STATE
====================== */

let project = JSON.parse(localStorage.getItem("rahulStudio")) || { pages:{} };
let currentPage = Object.keys(project.pages)[0] || "home";
if(!project.pages[currentPage]) project.pages[currentPage] = null;

/* ======================
   INIT EDITOR
====================== */

const editor = grapesjs.init({
  container:'#gjs',
  height:'100%',
  storageManager:false
});

editor.on('update', ()=> saveCurrent());

/* ======================
   ACADEMIC BLOCKS
====================== */

editor.BlockManager.add('unit-template',{
  label:'Unit Template',
  content:`
  <section style="padding:40px;">
    <h1>Unit Title</h1>
    <h3>Objectives</h3>
    <ul><li>Objective 1</li></ul>
    <h3>Content</h3>
    <p>Write structured notes here...</p>
  </section>`
});

editor.BlockManager.add('definition-box',{
  label:'Definition',
  content:`<div style="border-left:5px solid #2563eb;padding:15px;background:#f3f4f6;">
  <strong>Definition:</strong> Write here.</div>`
});

/* ======================
   PAGE MANAGEMENT
====================== */

function renderPages(){
  const list=document.getElementById("pageList");
  list.innerHTML="";
  Object.keys(project.pages).forEach(p=>{
    const btn=document.createElement("button");
    btn.innerText=p;
    btn.onclick=()=>switchPage(p);
    list.appendChild(btn);
  });

  new Sortable(list,{
    animation:150,
    onEnd:function(){
      const order=[];
      document.querySelectorAll("#pageList button")
      .forEach(btn=>order.push(btn.innerText));
      const reordered={};
      order.forEach(p=>reordered[p]=project.pages[p]);
      project.pages=reordered;
      saveCurrent();
    }
  });
}

function addPage(){
  const name=prompt("Page Name:");
  if(!name) return;
  saveCurrent();
  project.pages[name]=null;
  currentPage=name;
  editor.setComponents(`<h1>${name}</h1>`);
  saveCurrent();
  renderPages();
}

function switchPage(name){
  saveCurrent();
  currentPage=name;
  if(project.pages[name]){
    editor.loadProjectData(project.pages[name]);
  } else {
    editor.setComponents(`<h1>${name}</h1>`);
  }
}

function saveCurrent(){
  project.pages[currentPage]=editor.getProjectData();
  localStorage.setItem("rahulStudio", JSON.stringify(project));
}

/* ======================
   IMAGE INSERT
====================== */

function insertImage(){
  const file=document.getElementById("imageUpload").files[0];
  if(!file){ alert("Select image"); return; }

  const reader=new FileReader();
  reader.onload=function(e){
    editor.addComponents(`
      <figure style="text-align:center;padding:20px;">
        <img src="${e.target.result}" style="max-width:100%;border-radius:8px;">
        <figcaption>Image Caption</figcaption>
      </figure>
    `);
  };
  reader.readAsDataURL(file);
}

/* ======================
   SMART PDF EXTRACTION
====================== */

async function extractPDF(){
  const file=document.getElementById("pdfUpload").files[0];
  if(!file){ alert("Upload PDF"); return; }

  const reader=new FileReader();
  reader.onload=async function(){
    const pdf=await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
    let structured="";

    for(let i=1;i<=pdf.numPages;i++){
      const page=await pdf.getPage(i);
      const content=await page.getTextContent();
      const lines=content.items.map(it=>it.str);

      lines.forEach(line=>{
        if(line.match(/^[A-Z\s]{5,}$/)){
          structured+=`<h2>${line}</h2>`;
        }
        else if(line.match(/^\d+(\.\d+)*\s/)){
          structured+=`<h3>${line}</h3>`;
        }
        else structured+=line+" ";
      });

      structured+="<br><br>";
    }

    editor.addComponents(`<section><h1>Extracted Content</h1>${structured}</section>`);
  };
  reader.readAsArrayBuffer(file);
}

/* ======================
   EXPORT WEBSITE + SITEMAP
====================== */

async function exportAll(){
  saveCurrent();
  const zip=new JSZip();
  let sitemap='<?xml version="1.0"?><urlset>';

  Object.keys(project.pages).forEach(p=>{
    editor.loadProjectData(project.pages[p]);
    const html=editor.getHtml();
    const css=editor.getCss();
    const full=`<html><head><style>${css}</style></head><body>${html}</body></html>`;
    zip.file(p+".html",full);
    sitemap+=`<url><loc>${p}.html</loc></url>`;
  });

  sitemap+='</urlset>';
  zip.file("sitemap.xml",sitemap);

  const content=await zip.generateAsync({type:"blob"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(content);
  a.download="rahul-website.zip";
  a.click();
}

/* ======================
   EXPORT PDF
====================== */

function exportPDF(){
  const element=document.createElement("div");
  element.innerHTML=editor.getHtml();
  html2pdf().from(element).save(currentPage+".pdf");
}

/* ======================
   EXPORT DOCX
====================== */

async function exportDOCX(){
  const text=editor.getHtml().replace(/<[^>]+>/g,"");
  const doc=new docx.Document({
    sections:[{children:[new docx.Paragraph(text)]}]
  });
  const blob=await docx.Packer.toBlob(doc);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=currentPage+".docx";
  a.click();
}

/* ======================
   BACKUP
====================== */

function backupProject(){
  const blob=new Blob([JSON.stringify(project)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="backup.json";
  a.click();
}

function restoreProject(e){
  const reader=new FileReader();
  reader.onload=function(){
    project=JSON.parse(this.result);
    localStorage.setItem("rahulStudio",JSON.stringify(project));
    location.reload();
  };
  reader.readAsText(e.target.files[0]);
}

/* ======================
   UI
====================== */

function toggleDark(){ document.body.classList.toggle("dark"); }

document.getElementById("themeColor")
.addEventListener("input",e=>{
  document.querySelector(".topbar").style.background=e.target.value;
});

/* INIT */
renderPages();
switchPage(currentPage);

</script>

</body>
</html>
